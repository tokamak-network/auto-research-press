<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Research Report | AI-Backed Research</title>
    <meta name="description" content="Generate comprehensive AI-powered research reports">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="alternate icon" href="favicon.svg">
    <link rel="mask-icon" href="favicon.svg" color="#2563eb">

    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/article.css">
    <style>
        .create-report-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }

        .form-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .form-section h2 {
            margin: 0 0 1.5rem 0;
            font-size: 1.5rem;
            color: var(--text);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text);
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--background);
            color: var(--text);
            font-size: 1rem;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn {
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary-600);
            color: white;
            border-color: var(--primary-600);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--background);
        }

        .expert-proposals {
            display: none;
        }

        .expert-proposals.active {
            display: block;
        }

        .expert-card {
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .expert-card h3 {
            margin: 0 0 0.75rem 0;
            font-size: 1.125rem;
            color: var(--text);
        }

        .expert-card p {
            margin: 0 0 0.5rem 0;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .expert-card .focus-areas {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .focus-tag {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .estimate-box {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            margin-top: var(--space-6);
        }

        .estimate-box h3 {
            margin: 0 0 1rem 0;
            font-size: 1.125rem;
            color: var(--text);
        }

        .estimate-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .estimate-item {
            text-align: center;
        }

        .estimate-item .label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .estimate-item .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #3b82f6;
        }

        /* Cost Analytics */
        .cost-breakdown {
            background: var(--layer-01);
            border: 1px solid var(--border-subtle);
            border-radius: 0;
            padding: 16px;
            margin-top: 16px;
        }

        .cost-breakdown h4 {
            margin: 0 0 12px 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .cost-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .cost-row:last-child {
            border-bottom: none;
            margin-top: 8px;
            padding-top: 12px;
            border-top: 2px solid var(--border-subtle);
        }

        .cost-row .cost-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .cost-row .cost-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .cost-row:last-child .cost-value {
            font-size: 18px;
            color: var(--link-primary);
        }

        .time-breakdown {
            display: grid;
            grid-template-columns: 1fr 80px 100px;
            gap: 12px;
            margin-top: 12px;
        }

        .time-phase {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .time-phase-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .time-bar {
            height: 6px;
            background: var(--layer-01);
            border-radius: 0;
            overflow: hidden;
            margin-top: 4px;
        }

        .time-bar-fill {
            height: 100%;
            background: var(--link-primary);
        }

        /* Interactive Expert Cards */
        .expert-card-interactive {
            background: var(--background);
            border: 2px solid var(--border-subtle);
            border-radius: 0;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 70ms;
            cursor: move;
        }

        .expert-card-interactive:hover {
            border-color: var(--link-primary);
            box-shadow: 0 0 0 3px rgba(15, 98, 254, 0.1);
        }

        .expert-card-interactive.dragging {
            opacity: 0.5;
        }

        .expert-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .expert-card-title {
            flex: 1;
        }

        .expert-card-title h3 {
            margin: 0 0 4px 0;
            font-size: 16px;
            color: var(--text-primary);
        }

        .expert-card-title .model-badge {
            display: inline-block;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-tertiary);
            background: var(--layer-01);
            border: 1px solid var(--border-subtle);
            padding: 2px 8px;
            border-radius: 0;
        }

        .expert-card-actions {
            display: flex;
            gap: 4px;
        }

        .icon-btn {
            background: transparent;
            border: 1px solid var(--border-subtle);
            padding: 6px;
            cursor: pointer;
            transition: all 70ms;
            border-radius: 0;
        }

        .icon-btn:hover {
            background: var(--layer-01);
            border-color: var(--link-primary);
        }

        .icon-btn svg {
            width: 16px;
            height: 16px;
            color: var(--text-secondary);
        }

        .expert-card-body {
            margin-top: 12px;
        }

        .expert-rationale {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .focus-areas-editable {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .focus-tag-editable {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(15, 98, 254, 0.1);
            color: var(--link-primary);
            padding: 4px 10px;
            border-radius: 0;
            font-size: 12px;
            border: 1px solid transparent;
        }

        .focus-tag-editable:hover {
            border-color: var(--link-primary);
        }

        .focus-tag-remove {
            cursor: pointer;
            font-weight: bold;
            opacity: 0.6;
        }

        .focus-tag-remove:hover {
            opacity: 1;
        }

        .add-focus-area {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: transparent;
            border: 1px dashed var(--border-subtle);
            color: var(--text-tertiary);
            padding: 4px 10px;
            border-radius: 0;
            font-size: 12px;
            cursor: pointer;
        }

        .add-focus-area:hover {
            border-color: var(--link-primary);
            color: var(--link-primary);
        }

        .add-expert-btn {
            width: 100%;
            padding: 16px;
            background: transparent;
            border: 2px dashed var(--border-subtle);
            border-radius: 0;
            color: var(--text-tertiary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 70ms;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .add-expert-btn:hover {
            border-color: var(--link-primary);
            color: var(--link-primary);
            background: rgba(15, 98, 254, 0.05);
        }

        .progress-section {
            display: none;
        }

        .progress-section.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-600);
            transition: width 0.5s ease;
        }

        .status-message {
            text-align: center;
            font-size: 1.125rem;
            color: var(--text);
            margin-bottom: 1rem;
        }

        .round-info {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-box {
            background: #fee2e2;
            border: 1px solid #fca5a5;
            color: #991b1b;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .success-box {
            background: #d1fae5;
            border: 1px solid #6ee7b7;
            color: #065f46;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            margin-top: 1rem;
        }

        .success-box h3 {
            margin: 0 0 1rem 0;
            font-size: 1.5rem;
        }

        .success-box .btn {
            margin-top: 1rem;
        }

        /* Research Type Selector */
        .research-type-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-top: 12px;
        }

        .research-type-option {
            border: 2px solid var(--border-subtle);
            border-radius: 0;
            padding: 20px;
            cursor: pointer;
            transition: all 70ms;
            position: relative;
        }

        .research-type-option:hover {
            border-color: var(--link-primary);
            background: var(--layer-01);
        }

        .research-type-option input[type="radio"] {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 20px;
            height: 20px;
        }

        .type-content {
            padding-right: 32px;
        }

        .type-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .type-header strong {
            font-size: 18px;
            color: var(--text-primary);
        }

        .type-badge {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-tertiary);
            background: var(--layer-01);
            border: 1px solid var(--border-subtle);
            padding: 2px 8px;
            border-radius: 0;
        }

        .type-description {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .type-features {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .type-features li {
            font-size: 13px;
            color: var(--text-tertiary);
            padding-left: 20px;
            position: relative;
            margin-bottom: 4px;
        }

        .type-features li:before {
            content: "→";
            position: absolute;
            left: 0;
            color: var(--link-primary);
        }

        .help-text {
            font-size: 13px;
            color: var(--text-tertiary);
            display: block;
            margin-top: 8px;
        }

        /* Expert Customization */
        .expert-customization {
            border: 1px solid var(--border-subtle);
            border-radius: 0;
            margin-top: 12px;
        }

        .custom-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-subtle);
        }

        .custom-tab {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 70ms;
        }

        .custom-tab:hover {
            background: var(--layer-01);
            color: var(--text-primary);
        }

        .custom-tab.active {
            color: var(--link-primary);
            border-bottom-color: var(--link-primary);
        }

        .custom-content {
            padding: 20px;
        }

        .custom-panel {
            display: none;
        }

        .custom-panel.active {
            display: block;
        }

        .info-text {
            font-size: 14px;
            color: var(--text-secondary);
            padding: 16px;
            background: var(--layer-01);
            border: 1px solid var(--border-subtle);
            border-radius: 0;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
            margin-top: 12px;
        }

        .analysis-result {
            margin-top: 16px;
            padding: 16px;
            background: var(--layer-01);
            border: 1px solid var(--border-subtle);
            border-left: 4px solid var(--link-primary);
            border-radius: 0;
            display: none;
        }

        .analysis-result.active {
            display: block;
        }

        .analysis-result h4 {
            margin: 0 0 12px 0;
            font-size: 16px;
            color: var(--text-primary);
        }

        .analysis-result p {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-secondary);
            margin: 8px 0;
        }

        .analysis-result ul {
            list-style: none;
            padding: 0;
            margin: 12px 0;
        }

        .analysis-result li {
            font-size: 14px;
            color: var(--text-secondary);
            padding-left: 20px;
            position: relative;
            margin-bottom: 8px;
        }

        .analysis-result li:before {
            content: "✓";
            position: absolute;
            left: 0;
            color: var(--link-primary);
            font-weight: bold;
        }

        .file-upload {
            position: relative;
            border: 2px dashed var(--border-subtle);
            border-radius: 0;
            padding: 32px;
            text-align: center;
            transition: all 70ms;
        }

        .file-upload:hover {
            border-color: var(--link-primary);
            background: var(--layer-01);
        }

        .file-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            cursor: pointer;
        }

        .file-upload label {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .file-upload svg {
            width: 48px;
            height: 48px;
            color: var(--text-tertiary);
        }

        .file-upload span {
            font-size: 14px;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .research-type-selector {
                grid-template-columns: 1fr;
            }

            .custom-tabs {
                flex-wrap: wrap;
            }

            .custom-tab {
                flex: 1 1 50%;
            }
        }
    </style>
</head>
<body>
    <header class="site-header">
        <div class="container">
            <div class="header-nav">
                <a href="index.html" class="back-link">
                    <svg viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"/>
                    </svg>
                    Back to Research
                </a>
                <div class="header-content">
                    <h1 class="site-title">AI-Backed Research</h1>
                    <p class="site-subtitle">Create New Research Report</p>
                </div>
                <button class="theme-toggle" aria-label="Toggle dark mode">
                    <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                    <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <main class="create-report-container">
        <!-- Step 1: Research Configuration -->
        <div id="step-topic" class="form-section">
            <h2>1. Research Configuration</h2>

            <!-- Research Type Selection -->
            <div class="form-group">
                <label>Research Type</label>
                <div class="research-type-selector">
                    <div class="research-type-option" onclick="selectResearchType('survey')">
                        <input type="radio" name="research-type" value="survey" checked>
                        <div class="type-content">
                            <div class="type-header">
                                <strong>Survey</strong>
                                <span class="type-badge">Literature Review</span>
                            </div>
                            <p class="type-description">Comprehensive review of existing research, methodologies, and state-of-the-art. Best for understanding "what is known" about a topic.</p>
                            <ul class="type-features">
                                <li>Synthesizes existing literature</li>
                                <li>Identifies research gaps</li>
                                <li>Provides broad overview</li>
                            </ul>
                        </div>
                    </div>
                    <div class="research-type-option" onclick="selectResearchType('research')">
                        <input type="radio" name="research-type" value="research">
                        <div class="type-content">
                            <div class="type-header">
                                <strong>Research</strong>
                                <span class="type-badge">Original Analysis</span>
                            </div>
                            <p class="type-description">In-depth analysis with novel insights, comparisons, and conclusions. Best for investigating specific questions or hypotheses.</p>
                            <ul class="type-features">
                                <li>Original analysis & insights</li>
                                <li>Comparative evaluations</li>
                                <li>Novel conclusions</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Topic Input -->
            <div class="form-group">
                <label for="topic">Research Topic</label>
                <textarea
                    id="topic"
                    placeholder="e.g., Ethereum's Proof of Stake consensus mechanism, Bitcoin Lightning Network payment channels, or Solana's fee market dynamics"
                    rows="3"
                    required
                ></textarea>
                <small class="help-text">Describe the topic you want researched. Be specific about the aspects you're interested in.</small>
            </div>

            <!-- Expert Customization -->
            <div class="form-group">
                <label>Expert Team Customization (Optional)</label>
                <div class="expert-customization">
                    <div class="custom-tabs">
                        <button class="custom-tab active" onclick="switchCustomTab('none')">Auto-Select</button>
                        <button class="custom-tab" onclick="switchCustomTab('text')">Describe Expert</button>
                        <button class="custom-tab" onclick="switchCustomTab('url')">From URL</button>
                        <button class="custom-tab" onclick="switchCustomTab('pdf')">From PDF</button>
                    </div>

                    <div class="custom-content">
                        <div id="custom-none" class="custom-panel active">
                            <p class="info-text">AI will automatically propose expert reviewers based on your topic.</p>
                        </div>

                        <div id="custom-text" class="custom-panel">
                            <textarea id="expert-description" placeholder="Describe the type of expert you want (e.g., 'Cryptography expert specializing in zero-knowledge proofs' or 'Economist focused on token economics')" rows="3"></textarea>
                            <button class="btn btn-secondary btn-sm" onclick="analyzeExpertDescription()">Analyze Expert Profile</button>
                            <div id="expert-analysis" class="analysis-result"></div>
                        </div>

                        <div id="custom-url" class="custom-panel">
                            <input type="text" id="expert-url" placeholder="Enter URL (research paper, blog post, or Google Scholar profile)">
                            <button class="btn btn-secondary btn-sm" onclick="analyzeExpertURL()">Extract Expertise</button>
                            <div id="url-analysis" class="analysis-result"></div>
                        </div>

                        <div id="custom-pdf" class="custom-panel">
                            <div class="file-upload">
                                <input type="file" id="expert-pdf" accept=".pdf" onchange="analyzeExpertPDF()">
                                <label for="expert-pdf">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
                                    </svg>
                                    <span>Upload PDF (paper or profile)</span>
                                </label>
                            </div>
                            <div id="pdf-analysis" class="analysis-result"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="proposeTeam()">
                    Propose Expert Team →
                </button>
            </div>
            <div id="topic-error" class="error-box" style="display: none;"></div>
        </div>

        <!-- Step 2: Expert Team Proposal -->
        <div id="step-experts" class="form-section expert-proposals">
            <h2>2. Proposed Expert Team</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                Our AI has analyzed your topic and proposed the following expert reviewers:
            </p>
            <div id="expert-list"></div>

            <div class="estimate-box">
                <h3>Workflow Estimate</h3>
                <div class="estimate-grid">
                    <div class="estimate-item">
                        <div class="label">Experts</div>
                        <div class="value" id="est-experts">-</div>
                    </div>
                    <div class="estimate-item">
                        <div class="label">Review Rounds</div>
                        <div class="value" id="est-rounds">-</div>
                    </div>
                    <div class="estimate-item">
                        <div class="label">Est. Time</div>
                        <div class="value" id="est-time">-</div>
                    </div>
                    <div class="estimate-item">
                        <div class="label">Quality Threshold</div>
                        <div class="value" id="est-threshold">8.0/10</div>
                    </div>
                </div>

                <!-- Time Breakdown -->
                <div class="cost-breakdown">
                    <h4>Time Breakdown</h4>
                    <div id="time-breakdown-content"></div>
                </div>

                <!-- Cost Estimate -->
                <div class="cost-breakdown">
                    <h4>Cost Estimate</h4>
                    <div class="cost-row">
                        <span class="cost-label">Input Tokens</span>
                        <span class="cost-value" id="cost-input-tokens">~50,000</span>
                    </div>
                    <div class="cost-row">
                        <span class="cost-label">Output Tokens</span>
                        <span class="cost-value" id="cost-output-tokens">~15,000</span>
                    </div>
                    <div class="cost-row">
                        <span class="cost-label">Model</span>
                        <span class="cost-value" id="cost-model">Claude Opus 4.5</span>
                    </div>
                    <div class="cost-row">
                        <span class="cost-label">Estimated Cost</span>
                        <span class="cost-value" id="cost-total">$0.75</span>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-secondary" onclick="backToTopic()">← Back</button>
                <button class="btn btn-primary" onclick="configureWorkflow()">Configure Workflow →</button>
            </div>
        </div>

        <!-- Step 3: Workflow Configuration -->
        <div id="step-config" class="form-section" style="display: none;">
            <h2>3. Workflow Configuration</h2>
            <div class="form-group">
                <label for="max-rounds">Maximum Review Rounds</label>
                <input type="number" id="max-rounds" value="3" min="1" max="10">
            </div>
            <div class="form-group">
                <label for="threshold">Quality Threshold (0-10)</label>
                <input type="number" id="threshold" value="8.0" min="5.0" max="10.0" step="0.1">
            </div>
            <div class="button-group">
                <button class="btn btn-secondary" onclick="backToExperts()">← Back</button>
                <button class="btn btn-primary" onclick="startWorkflow()">Generate Report</button>
            </div>
            <div id="config-error" class="error-box" style="display: none;"></div>
        </div>

        <!-- Step 4: Progress -->
        <div id="step-progress" class="form-section progress-section">
            <h2>Generating Research Report</h2>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            </div>
            <div class="status-message" id="status-message">Initializing workflow...</div>
            <div class="round-info" id="round-info">Round 0 of 3</div>
            <div class="spinner"></div>
        </div>

        <!-- Step 5: Success -->
        <div id="step-success" class="form-section" style="display: none;">
            <div class="success-box">
                <h3>Report Generated Successfully</h3>
                <p>Your research report has been completed and is ready to view.</p>
                <div class="button-group" style="justify-content: center;">
                    <button class="btn btn-primary" onclick="viewReport()">View Report</button>
                    <button class="btn btn-secondary" onclick="window.location.reload()">Create Another</button>
                </div>
            </div>
        </div>
    </main>

    <footer class="site-footer">
        <div class="container">
            <p><strong>Platform:</strong> AI-Backed Research | Tokamak Network Research Lab</p>
            <p class="copyright">© 2026 Tokamak Network Research Lab. All rights reserved.</p>
        </div>
    </footer>

    <script src="js/main.js"></script>
    <script>
        const API_BASE = 'http://localhost:8000';
        let currentProposal = null;
        let currentProjectId = null;
        let customExpertContext = null;

        // Research type selection
        function selectResearchType(type) {
            document.querySelectorAll('.research-type-option input').forEach(input => {
                input.checked = (input.value === type);
            });
        }

        // Tab switching for expert customization
        function switchCustomTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.custom-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update panels
            document.querySelectorAll('.custom-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            document.getElementById(`custom-${tab}`).classList.add('active');
        }

        // Analyze expert description
        async function analyzeExpertDescription() {
            const description = document.getElementById('expert-description').value.trim();
            const resultDiv = document.getElementById('expert-analysis');

            if (!description) {
                alert('Please enter an expert description');
                return;
            }

            resultDiv.innerHTML = '<p style="color: var(--text-tertiary);">Analyzing...</p>';
            resultDiv.classList.add('active');

            // Simulate API call (you'll need to implement this on backend)
            setTimeout(() => {
                customExpertContext = {
                    type: 'description',
                    content: description
                };

                resultDiv.innerHTML = `
                    <h4>Expert Profile Extracted</h4>
                    <p><strong>Expertise:</strong> ${description}</p>
                    <ul>
                        <li>Will be considered when proposing expert team</li>
                        <li>AI will find reviewers matching this profile</li>
                    </ul>
                `;
            }, 1000);
        }

        // Analyze expert URL
        async function analyzeExpertURL() {
            const url = document.getElementById('expert-url').value.trim();
            const resultDiv = document.getElementById('url-analysis');

            if (!url) {
                alert('Please enter a URL');
                return;
            }

            resultDiv.innerHTML = '<p style="color: var(--text-tertiary);">Extracting expertise from URL...</p>';
            resultDiv.classList.add('active');

            // Simulate API call
            setTimeout(() => {
                customExpertContext = {
                    type: 'url',
                    content: url
                };

                resultDiv.innerHTML = `
                    <h4>Expertise Extracted from URL</h4>
                    <p><strong>Source:</strong> ${url}</p>
                    <ul>
                        <li>Analyzing author expertise and topics</li>
                        <li>Will match reviewers with similar background</li>
                    </ul>
                `;
            }, 1500);
        }

        // Analyze expert PDF
        async function analyzeExpertPDF() {
            const fileInput = document.getElementById('expert-pdf');
            const file = fileInput.files[0];
            const resultDiv = document.getElementById('pdf-analysis');

            if (!file) {
                return;
            }

            resultDiv.innerHTML = '<p style="color: var(--text-tertiary);">Analyzing PDF...</p>';
            resultDiv.classList.add('active');

            // Simulate API call
            setTimeout(() => {
                customExpertContext = {
                    type: 'pdf',
                    content: file.name
                };

                resultDiv.innerHTML = `
                    <h4>PDF Analysis Complete</h4>
                    <p><strong>File:</strong> ${file.name}</p>
                    <ul>
                        <li>Extracted author expertise and research focus</li>
                        <li>Will find reviewers with matching specialization</li>
                    </ul>
                `;
            }, 2000);
        }

        async function proposeTeam() {
            const topic = document.getElementById('topic').value.trim();
            const researchType = document.querySelector('input[name="research-type"]:checked').value;
            const errorDiv = document.getElementById('topic-error');

            if (!topic) {
                errorDiv.textContent = 'Please enter a research topic.';
                errorDiv.style.display = 'block';
                return;
            }

            errorDiv.style.display = 'none';

            // Build request with research type and custom context
            const requestBody = {
                topic: topic,
                research_type: researchType
            };

            if (customExpertContext) {
                requestBody.expert_context = customExpertContext;
            }

            try {
                const response = await fetch(`${API_BASE}/api/propose-team`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const proposal = await response.json();
                currentProposal = proposal;
                displayProposal(proposal);

                // Show expert section
                document.getElementById('step-experts').classList.add('active');
                document.getElementById('step-experts').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                errorDiv.textContent = `Error: ${error.message}`;
                errorDiv.style.display = 'block';
            }
        }

        function displayProposal(proposal) {
            const expertList = document.getElementById('expert-list');
            expertList.innerHTML = '';

            proposal.proposed_experts.forEach((expert, idx) => {
                const card = document.createElement('div');
                card.className = 'expert-card-interactive';
                card.draggable = true;
                card.dataset.expertId = idx;
                card.innerHTML = `
                    <div class="expert-card-header">
                        <div class="expert-card-title">
                            <h3>${idx + 1}. ${expert.expert_domain}</h3>
                            <span class="model-badge">${expert.suggested_model}</span>
                        </div>
                        <div class="expert-card-actions">
                            <button class="icon-btn" onclick="editExpert(${idx})" title="Edit">
                                <svg viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                                </svg>
                            </button>
                            <button class="icon-btn" onclick="removeExpert(${idx})" title="Remove">
                                <svg viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="expert-card-body">
                        <p class="expert-rationale">${expert.rationale}</p>
                        <div class="focus-areas-editable" id="focus-areas-${idx}">
                            ${expert.focus_areas.map(area => `
                                <span class="focus-tag-editable">
                                    ${area}
                                    <span class="focus-tag-remove" onclick="removeFocusArea(${idx}, '${area}')">×</span>
                                </span>
                            `).join('')}
                            <button class="add-focus-area" onclick="addFocusArea(${idx})">+ Add Focus</button>
                        </div>
                    </div>
                `;
                expertList.appendChild(card);

                // Add drag-and-drop listeners
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('drop', handleDrop);
                card.addEventListener('dragend', handleDragEnd);
            });

            // Add "Add Expert" button
            const addBtn = document.createElement('button');
            addBtn.className = 'add-expert-btn';
            addBtn.innerHTML = '<svg viewBox="0 0 20 20" fill="currentColor" style="width: 20px; height: 20px;"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/></svg> Add Another Expert';
            addBtn.onclick = addNewExpert;
            expertList.appendChild(addBtn);

            // Update estimates
            document.getElementById('est-experts').textContent = proposal.recommended_num_experts;
            document.getElementById('est-rounds').textContent = proposal.estimated_rounds;
            document.getElementById('est-time').textContent = `~${proposal.estimated_time_minutes}min`;

            // Calculate and display cost breakdown
            updateCostEstimate(proposal);
            updateTimeBreakdown(proposal);
        }

        function updateCostEstimate(proposal) {
            const numExperts = proposal.recommended_num_experts;
            const numRounds = proposal.estimated_rounds;
            const model = proposal.proposed_experts[0]?.suggested_model || 'claude-opus-4.5';

            // Rough estimates
            const inputTokensPerExpert = 5000 * numRounds;
            const outputTokensPerExpert = 2000 * numRounds;
            const totalInput = inputTokensPerExpert * numExperts;
            const totalOutput = outputTokensPerExpert * numExperts;

            // Cost calculation (per 1M tokens)
            const pricing = {
                'claude-opus-4.5': { input: 15, output: 75 },
                'claude-sonnet-4': { input: 3, output: 15 }
            };
            const modelPrice = pricing[model] || pricing['claude-opus-4.5'];
            const inputCost = (totalInput / 1_000_000) * modelPrice.input;
            const outputCost = (totalOutput / 1_000_000) * modelPrice.output;
            const totalCost = inputCost + outputCost;

            document.getElementById('cost-input-tokens').textContent = `~${totalInput.toLocaleString()}`;
            document.getElementById('cost-output-tokens').textContent = `~${totalOutput.toLocaleString()}`;
            document.getElementById('cost-model').textContent = model;
            document.getElementById('cost-total').textContent = `$${totalCost.toFixed(2)}`;
        }

        function updateTimeBreakdown(proposal) {
            const container = document.getElementById('time-breakdown-content');
            const phases = [
                { label: 'Initial Draft', time: 5, percent: 28 },
                { label: `Round 1 Review`, time: proposal.recommended_num_experts * 2, percent: 33 },
                { label: `Round 2 Review`, time: proposal.recommended_num_experts * 1.5, percent: 22 },
                { label: 'Final Revision', time: 3, percent: 17 }
            ];

            container.innerHTML = phases.map(phase => `
                <div style="margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span class="time-phase-label">${phase.label}</span>
                        <span class="time-phase-label">${phase.time} min (${phase.percent}%)</span>
                    </div>
                    <div class="time-bar">
                        <div class="time-bar-fill" style="width: ${phase.percent}%"></div>
                    </div>
                </div>
            `).join('');
        }

        // Drag and drop functions
        let draggedElement = null;

        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            if (draggedElement !== this) {
                const allCards = Array.from(document.querySelectorAll('.expert-card-interactive'));
                const draggedIndex = allCards.indexOf(draggedElement);
                const targetIndex = allCards.indexOf(this);

                if (draggedIndex < targetIndex) {
                    this.parentNode.insertBefore(draggedElement, this.nextSibling);
                } else {
                    this.parentNode.insertBefore(draggedElement, this);
                }

                // Update proposal order
                const draggedId = parseInt(draggedElement.dataset.expertId);
                const targetId = parseInt(this.dataset.expertId);
                const expert = currentProposal.proposed_experts.splice(draggedId, 1)[0];
                currentProposal.proposed_experts.splice(targetId, 0, expert);
            }
            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
        }

        function editExpert(idx) {
            const expert = currentProposal.proposed_experts[idx];
            const newDomain = prompt('Edit expert domain:', expert.expert_domain);
            if (newDomain && newDomain.trim()) {
                expert.expert_domain = newDomain.trim();
                displayProposal(currentProposal);
            }
        }

        function removeExpert(idx) {
            if (confirm('Remove this expert from the team?')) {
                currentProposal.proposed_experts.splice(idx, 1);
                currentProposal.recommended_num_experts--;
                displayProposal(currentProposal);
            }
        }

        function addFocusArea(idx) {
            const area = prompt('Enter new focus area:');
            if (area && area.trim()) {
                currentProposal.proposed_experts[idx].focus_areas.push(area.trim());
                displayProposal(currentProposal);
            }
        }

        function removeFocusArea(idx, area) {
            const expert = currentProposal.proposed_experts[idx];
            expert.focus_areas = expert.focus_areas.filter(a => a !== area);
            displayProposal(currentProposal);
        }

        function addNewExpert() {
            const domain = prompt('Enter expert domain (e.g., "Zero-Knowledge Cryptography Expert"):');
            if (!domain || !domain.trim()) return;

            const focusInput = prompt('Enter focus areas (comma-separated):');
            const focusAreas = focusInput ? focusInput.split(',').map(s => s.trim()) : [];

            const newExpert = {
                expert_domain: domain.trim(),
                rationale: 'Custom expert added by user',
                focus_areas: focusAreas,
                suggested_model: 'claude-opus-4.5'
            };

            currentProposal.proposed_experts.push(newExpert);
            currentProposal.recommended_num_experts++;
            displayProposal(currentProposal);
        }

        function configureWorkflow() {
            document.getElementById('step-config').style.display = 'block';
            document.getElementById('step-config').scrollIntoView({ behavior: 'smooth' });
        }

        async function startWorkflow() {
            const maxRounds = parseInt(document.getElementById('max-rounds').value);
            const threshold = parseFloat(document.getElementById('threshold').value);
            const errorDiv = document.getElementById('config-error');

            if (!currentProposal) {
                errorDiv.textContent = 'No team proposal found. Please go back and propose a team.';
                errorDiv.style.display = 'block';
                return;
            }

            errorDiv.style.display = 'none';

            try {
                const response = await fetch(`${API_BASE}/api/start-workflow`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic: currentProposal.topic,
                        experts: currentProposal.proposed_experts,
                        max_rounds: maxRounds,
                        threshold: threshold
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const result = await response.json();
                currentProjectId = result.project_id;

                // Redirect to queue page
                window.location.href = `research-queue.html?highlight=${result.project_id}`;

            } catch (error) {
                errorDiv.textContent = `Error: ${error.message}`;
                errorDiv.style.display = 'block';
            }
        }

        async function pollWorkflowStatus() {
            if (!currentProjectId) return;

            try {
                const response = await fetch(`${API_BASE}/api/workflow-status/${currentProjectId}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const status = await response.json();

                // Update UI
                document.getElementById('progress-fill').style.width = `${status.progress_percentage}%`;
                document.getElementById('status-message').textContent = status.message;
                document.getElementById('round-info').textContent =
                    `Round ${status.current_round} of ${status.total_rounds}`;

                if (status.status === 'completed') {
                    // Show success
                    document.getElementById('step-progress').style.display = 'none';
                    document.getElementById('step-success').style.display = 'block';
                    document.getElementById('step-success').scrollIntoView({ behavior: 'smooth' });
                } else if (status.status === 'failed') {
                    // Show error
                    alert(`Workflow failed: ${status.error}`);
                } else {
                    // Continue polling
                    setTimeout(pollWorkflowStatus, 2000);
                }

            } catch (error) {
                console.error('Error polling status:', error);
                setTimeout(pollWorkflowStatus, 2000);
            }
        }

        function viewReport() {
            if (currentProjectId) {
                window.location.href = `review-viewer.html?id=${currentProjectId}`;
            }
        }

        function backToTopic() {
            document.getElementById('step-experts').classList.remove('active');
        }

        function backToExperts() {
            document.getElementById('step-config').style.display = 'none';
        }
    </script>
</body>
</html>
