<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading... | Autonomous Research Press</title>
    <meta name="description" content="AI-powered research article">

    <!-- Open Graph / Social Media -->
    <meta property="og:type" content="article">
    <meta property="og:title" content="Autonomous Research Press">
    <meta property="og:description" content="AI-powered academic research with rigorous peer review">
    <meta property="og:image" content="https://ar-press.com/images/og-cover.png">
    <meta property="og:site_name" content="Autonomous Research Press">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://ar-press.com/images/og-cover.png">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="alternate icon" href="favicon.svg">
    <link rel="mask-icon" href="favicon.svg" color="#2563eb">

    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/article.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.css">
    <style>
        .loading-state {
            text-align: center;
            padding: 120px 20px;
            color: var(--text-secondary);
        }
        .loading-state .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top-color: var(--primary-600);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-state {
            text-align: center;
            padding: 120px 20px;
            color: #991b1b;
        }
        .tldr-box {
            background: var(--layer-01, #f4f4f4);
            border: 1px solid var(--border-subtle, #e0e0e0);
            border-left: 4px solid var(--link-primary, #0f62fe);
            padding: 1.25rem 1.5rem;
            margin-bottom: 2rem;
            font-size: 1.05rem;
            line-height: 1.7;
            color: var(--text-primary, #161616);
        }
        .tldr-box .tldr-label {
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text-tertiary, #6f6f6f);
            margin-bottom: 0.5rem;
        }
        .tldr-box p {
            margin: 0;
        }
        /* Citation hyperlinks */
        /* Download button */
        .download-report-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            border: 1px solid var(--border-subtle, #e0e0e0);
            background: transparent;
            color: var(--text-secondary, #525252);
            font-size: 0.8125rem;
            font-weight: 500;
            font-family: var(--font-sans);
            cursor: pointer;
            border-radius: 0;
            transition: all 70ms cubic-bezier(0.2, 0, 0.38, 0.9);
            text-decoration: none;
        }
        .download-report-btn:hover {
            background: var(--background-hover, #e8e8e8);
            color: var(--text-primary, #161616);
            border-color: var(--text-secondary, #525252);
        }
        .download-report-btn svg {
            width: 14px;
            height: 14px;
        }
        .citation-link {
            color: #2563eb;
            text-decoration: none;
            font-weight: 600;
            padding: 0 2px;
            transition: background-color 70ms;
            cursor: pointer;
        }
        .citation-link:hover {
            background-color: #dbeafe;
            border-radius: 2px;
        }
        .citation-group {
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <header class="site-header">
        <div class="container">
            <div class="header-nav">
                <a href="index.html" class="back-link">
                    <svg viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"/>
                    </svg>
                    Back to Research
                </a>
                <div class="header-content">
                    <h1 class="site-title">Autonomous Research Press</h1>
                    <p class="site-subtitle">Autonomous Research Platform</p>
                </div>
                <button class="theme-toggle" aria-label="Toggle dark mode">
                    <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                    <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <main class="article-layout">
        <button class="toc-toggle" aria-label="Toggle table of contents">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
            ToC
        </button>

        <aside class="toc-sidebar">
            <div class="toc-sticky">
                <h3 class="toc-title">On This Page</h3>
                <nav class="toc-nav">
                    <ul id="toc-list"></ul>
                </nav>
            </div>
        </aside>

        <article class="research-report">
            <header class="article-header" id="article-header">
                <div class="loading-state" id="loading-state">
                    <div class="spinner"></div>
                    <p>Loading article...</p>
                </div>
            </header>
            <div id="article-content"></div>
        </article>
    </main>

    <footer class="site-footer">
        <div class="container">
            <p><strong>Platform:</strong> Autonomous Research Press</p>
            <p class="copyright">2026 Autonomous Research Press. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/contrib/auto-render.min.js"></script>
    <script src="js/main.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        const projectId = params.get('id');

        if (!projectId) {
            document.getElementById('loading-state').innerHTML = '<p>No project ID specified. <a href="index.html">Back to home</a></p>';
        } else {
            loadArticle(projectId);
        }

        async function loadArticle(id) {
            try {
                const [metaRes, manuscriptsRes] = await Promise.all([
                    fetch(`/api/projects/${id}`),
                    fetch(`/api/projects/${id}/manuscripts`)
                ]);

                if (!metaRes.ok) throw new Error('Project not found');
                if (!manuscriptsRes.ok) throw new Error('Manuscripts not found');

                const meta = await metaRes.json();
                const manuscripts = await manuscriptsRes.json();

                // Find latest versioned manuscript
                const versionedKeys = Object.keys(manuscripts).filter(k => k.includes('_v'));
                let latestKey;
                if (versionedKeys.length > 0) {
                    latestKey = versionedKeys.reduce((a, b) => {
                        const numA = parseInt(a.split('_v')[1]);
                        const numB = parseInt(b.split('_v')[1]);
                        return numA > numB ? a : b;
                    });
                } else {
                    latestKey = manuscripts['manuscript_final'] ? 'manuscript_final' : Object.keys(manuscripts)[0];
                }

                const manuscriptText = manuscripts[latestKey];

                // Get metadata
                const rounds = meta.rounds || [];
                const finalRound = rounds[rounds.length - 1] || {};
                const finalScore = finalRound.overall_average || meta.final_score || 0;
                const finalDecision = finalRound.moderator_decision?.decision || 'PENDING';
                const version = rounds.length;
                const expertTeam = meta.expert_team || [];
                const audienceLevel = meta.audience_level || 'professional';
                const researchType = meta.research_type || null;

                // Update page title
                document.title = `${meta.topic} | Autonomous Research Press`;

                // Render article header
                const header = document.getElementById('article-header');
                header.innerHTML = `
                    <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(37, 99, 235, 0.08) 100%); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 2px; padding: 1rem 1.25rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
                        <svg viewBox="0 0 20 20" fill="currentColor" style="width: 20px; height: 20px; color: #3b82f6; flex-shrink: 0;">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                        </svg>
                        <span style="font-size: 0.9rem;">
                            This article shows the <strong>latest version</strong> of the manuscript.
                            <a href="review.html?id=${id}" style="color: #3b82f6; text-decoration: underline; font-weight: 600;">View full review board</a> to see all versions, reviewer feedback, and revision history.
                        </span>
                    </div>
                    <h1 class="article-title">${meta.topic}</h1>
                    <div class="article-meta">
                        ${researchType ? `<span class="meta-item" style="padding:2px 8px;background:var(--layer-01);border:1px solid var(--border-subtle);font-weight:600;font-size:12px;text-transform:uppercase;letter-spacing:0.5px;color:${researchType === 'survey' ? '#8a3ffc' : '#0f62fe'};">${researchType === 'survey' ? 'Survey' : 'Original Research'}</span>` : ''}
                        <span class="meta-item"><strong>Version:</strong> ${version}</span>
                        <span class="meta-item"><strong>Review Score:</strong> ${finalScore}/10</span>
                        <span class="meta-item"><strong>Status:</strong> ${finalDecision.replace(/_/g, ' ')}</span>
                        ${audienceLevel !== 'professional' ? `<span class="meta-item"><strong>Audience:</strong> ${audienceLevel === 'beginner' ? 'Beginner-Friendly' : 'Intermediate'}</span>` : ''}
                        <button class="download-report-btn" onclick="downloadReport('${id}')">
                            <svg viewBox="0 0 16 16" fill="currentColor"><path d="M2.75 14A1.75 1.75 0 0 1 1 12.25v-2.5a.75.75 0 0 1 1.5 0v2.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25v-2.5a.75.75 0 0 1 1.5 0v2.5A1.75 1.75 0 0 1 13.25 14H2.75z"/><path d="M7.25 7.689V2a.75.75 0 0 1 1.5 0v5.689l1.97-1.969a.749.749 0 1 1 1.06 1.06l-3.25 3.25a.749.749 0 0 1-1.06 0L4.22 6.78a.749.749 0 1 1 1.06-1.06l1.97 1.969z"/></svg>
                            Download .md
                        </button>
                    </div>
                `;

                // Render manuscript content
                renderManuscript(manuscriptText);

            } catch (error) {
                document.getElementById('loading-state').innerHTML =
                    `<div class="error-state"><p>Error: ${error.message}</p><p><a href="index.html">Back to home</a></p></div>`;
            }
        }

        function renderManuscript(markdownContent) {
            // Extract TL;DR section if present (before main rendering)
            let tldrHtml = '';
            const tldrMatch = markdownContent.match(/^##\s*TL;?DR\s*\n([\s\S]*?)(?=\n##\s)/im);
            if (tldrMatch) {
                const tldrText = tldrMatch[1].trim();
                tldrHtml = `<div class="tldr-box"><div class="tldr-label">TL;DR</div>${marked.parse(tldrText)}</div>`;
                // Remove TL;DR section from manuscript to avoid duplicate rendering
                markdownContent = markdownContent.replace(/^##\s*TL;?DR\s*\n[\s\S]*?(?=\n##\s)/im, '');
            }

            // Pre-process: only wrap explicitly mathematical patterns in $...$
            // Be conservative — only match patterns that are unambiguously math notation
            // Already $-delimited math is handled by KaTeX later
            let processedContent = markdownContent
                // Inline: Adv^{...}_A(...), Pr[b' = b], negl(λ) — formal crypto notation with braces
                .replace(/(?<![`$\\])(\b\w+\^?\{[^}]+\}(?:_\w+|\([^)]*\))*)(?![`$])/g, (match, expr) => {
                    // Only wrap if it has both braces AND sub/superscript — clearly math
                    if (/[_^]\{/.test(expr)) return `$${expr}$`;
                    return match;
                })
                // Inline: Pr[...], E[...] probability/expectation notation
                .replace(/(?<![`$])(\b(Pr|E)\[[^\]]{2,}\])(?![`$])/g, (match, expr) => {
                    return `$${expr}$`;
                })
                // Inline: negl(λ), poly(λ) — function with single Greek argument
                .replace(/(?<![`$\w])(negl|poly)\(([λεδσ])\)(?![`$])/g, (match, fn, arg) => {
                    return `$\\text{${fn}}(${arg})$`;
                });

            // Protect math blocks from marked processing
            const mathBlocks = [];
            let protectedContent = processedContent
                .replace(/\$\$[\s\S]+?\$\$/g, match => {
                    mathBlocks.push(match);
                    return `%%MATH_BLOCK_${mathBlocks.length - 1}%%`;
                })
                .replace(/\$(?!\$)([^\$\n]+?)\$/g, match => {
                    mathBlocks.push(match);
                    return `%%MATH_BLOCK_${mathBlocks.length - 1}%%`;
                });

            // Parse markdown (math is safely extracted)
            let htmlContent = marked.parse(protectedContent);

            // Restore math blocks
            mathBlocks.forEach((block, i) => {
                htmlContent = htmlContent.replace(`%%MATH_BLOCK_${i}%%`, block);
            });

            // Create temporary div to process HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;

            // Wrap sections with proper section tags and IDs
            let currentSection = null;
            const contentDiv = document.createElement('div');
            const tocItems = [];

            Array.from(tempDiv.children).forEach(el => {
                if (el.tagName === 'H2') {
                    if (currentSection) contentDiv.appendChild(currentSection);
                    currentSection = document.createElement('section');
                    currentSection.className = 'section';

                    let text = el.textContent;
                    text = text.replace(/^\d+(\.\d+)*\.?\s*/, '');
                    let slug = text.toLowerCase()
                        .replace(/[:.]/g, '')
                        .replace(/&/g, 'and')
                        .replace(/\s+/g, '-')
                        .replace(/[^a-z0-9-]/g, '');
                    currentSection.id = slug;
                    el.id = slug;
                    currentSection.appendChild(el);
                    tocItems.push({ title: text, slug: slug });
                } else if (currentSection) {
                    currentSection.appendChild(el);
                } else {
                    contentDiv.appendChild(el);
                }
            });

            if (currentSection) contentDiv.appendChild(currentSection);

            // Apply styling classes
            contentDiv.querySelectorAll('p').forEach(p => {
                const text = p.textContent.trim();
                const html = p.innerHTML;
                if (p.previousElementSibling?.tagName === 'H2' &&
                    p.previousElementSibling.textContent.includes('Executive Summary')) {
                    p.className = 'lead';
                }
                if (text.startsWith('Key findings') || text.startsWith('Key insight') ||
                    text.startsWith('Key Findings') || text.startsWith('Key Insight')) {
                    p.className = 'key-insight';
                }
                if (html.includes('<strong>Practical implications:') || html.includes('<strong>Practical Implications:')) {
                    p.className = 'insight';
                }
                if (html.includes('<strong>Historical context:') || html.includes('<strong>Historical Context:')) {
                    p.className = 'historical-context';
                }
                if (html.includes('<strong>Impact on') || html.includes('<strong>The ') || html.includes('<strong>This ')) {
                    if (p.className === '') p.className = 'insight';
                }
            });

            contentDiv.querySelectorAll('pre').forEach(pre => {
                const code = pre.querySelector('code');
                if (code) pre.className = 'code-block';
            });

            contentDiv.querySelectorAll('ul').forEach(ul => {
                const prevEl = ul.previousElementSibling;
                if (prevEl && prevEl.tagName === 'P') {
                    const text = prevEl.textContent.trim();
                    if (text.includes('Key findings') || text.includes('Key Findings') ||
                        text.includes('findings indicate') || text.includes('Key metrics')) {
                        const box = document.createElement('div');
                        box.className = 'highlight-box';
                        const title = document.createElement('h3');
                        title.textContent = 'Key Findings:';
                        box.appendChild(title);
                        box.appendChild(ul.cloneNode(true));
                        ul.replaceWith(box);
                    }
                }
            });

            // Build TOC
            const tocList = document.getElementById('toc-list');
            tocList.innerHTML = tocItems.slice(0, 10).map(h =>
                `<li><a href="#${h.slug}">${h.title}</a></li>`
            ).join('');

            // Insert content (with TL;DR box at the top if present)
            document.getElementById('article-content').innerHTML = tldrHtml + contentDiv.innerHTML;

            // Wrap tables in scrollable container for mobile
            document.getElementById('article-content').querySelectorAll('table').forEach(table => {
                const wrapper = document.createElement('div');
                wrapper.className = 'table-wrapper';
                table.parentNode.insertBefore(wrapper, table);
                wrapper.appendChild(table);
            });

            // Render math with KaTeX
            function renderMath() {
                if (window.renderMathInElement) {
                    renderMathInElement(document.getElementById('article-content'), {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false},
                            {left: '\\(', right: '\\)', display: false},
                            {left: '\\[', right: '\\]', display: true}
                        ],
                        throwOnError: false
                    });
                } else {
                    setTimeout(renderMath, 100);
                }
            }
            renderMath();
        }

        async function downloadReport(id) {
            try {
                const res = await fetch(`/api/projects/${id}/report`);
                if (!res.ok) throw new Error('Failed to download report');
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${id}-report.md`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (e) {
                alert('Download failed: ' + e.message);
            }
        }

        function highlightReference(refId) {
            const viewer = document.getElementById('article-content');
            if (!viewer) return;
            const refPattern = new RegExp(`\\[${refId}\\]\\s+[^\\[]+`, 'i');
            const walker = document.createTreeWalker(viewer, NodeFilter.SHOW_TEXT, null, false);
            let node;
            while (node = walker.nextNode()) {
                if (refPattern.test(node.textContent)) {
                    const element = node.parentElement;
                    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    const originalBg = element.style.backgroundColor;
                    const originalBorder = element.style.borderLeft;
                    element.style.backgroundColor = '#fef3c7';
                    element.style.borderLeft = '4px solid #f59e0b';
                    setTimeout(() => {
                        element.style.backgroundColor = originalBg;
                        element.style.borderLeft = originalBorder;
                    }, 2000);
                    break;
                }
            }
        }
    </script>
</body>
</html>
