<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ask Research | Autonomous Research Press</title>
    <meta name="description" content="Generate comprehensive AI-powered research reports">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="alternate icon" href="favicon.svg">
    <link rel="mask-icon" href="favicon.svg" color="#2563eb">

    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/article.css">
    <style>
        .ask-topic-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }

        .form-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 2px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .form-section h2 {
            margin: 0 0 1.5rem 0;
            font-size: 1.5rem;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .step-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: var(--primary-600);
            color: white;
            border-radius: 2px;
            font-size: 0.875rem;
            font-weight: 700;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 2px;
            background: var(--background);
            color: var(--text);
            font-size: 1rem;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .help-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn {
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 0;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary-600);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--background);
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Category Selection */
        .category-section {
            display: none;
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 2px;
        }

        .category-section.active {
            display: block;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .category-header h3 {
            margin: 0;
            font-size: 1rem;
            color: var(--text);
        }

        .category-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border-radius: 0;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .category-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .category-select-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        /* Team Display */
        .team-section {
            display: none;
        }

        .team-section.active {
            display: block;
        }

        .team-group {
            margin-bottom: 2rem;
        }

        .team-group-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .team-group-header h3 {
            margin: 0;
            font-size: 1.125rem;
            color: var(--text);
        }

        .team-group-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 2px;
            color: var(--text-secondary);
        }

        .author-card {
            background: var(--background);
            border: 2px solid var(--border);
            border-radius: 2px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            position: relative;
        }

        .author-card.lead {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.05);
        }

        .author-card.lead::before {
            content: "LEAD";
            position: absolute;
            top: -10px;
            left: 12px;
            background: #f59e0b;
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 0;
        }

        .author-card.reviewer {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.05);
        }

        .author-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .author-name {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
            margin: 0;
        }

        .author-model {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 2px;
            color: var(--text-secondary);
        }

        .author-rationale {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            line-height: 1.5;
        }

        .author-focus-areas {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .focus-tag {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border-radius: 0;
        }

        .author-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }

        .author-action-btn {
            font-size: 0.75rem;
            padding: 0.375rem 0.75rem;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 0;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .author-action-btn:hover {
            background: var(--surface);
            border-color: var(--primary-600);
            color: var(--primary-600);
        }

        /* Customization Modal */
        .customization-panel {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 2px;
        }

        .customization-panel.active {
            display: block;
        }

        .custom-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .custom-tab {
            flex: 1;
            padding: 0.5rem;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 0;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .custom-tab.active {
            background: var(--primary-600);
            border-color: var(--primary-600);
            color: white;
        }

        .custom-content textarea,
        .custom-content input {
            width: 100%;
            padding: 0.5rem;
            font-size: 0.875rem;
        }

        /* Settings */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }

        .setting-item {
            text-align: center;
        }

        .setting-item label {
            display: block;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .setting-item input {
            width: 80px;
            text-align: center;
            font-size: 1.25rem;
            font-weight: 600;
        }

        /* Estimate Box */
        .estimate-box {
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 2px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .estimate-box h3 {
            margin: 0 0 1rem 0;
            font-size: 1rem;
            color: var(--text);
        }

        .estimate-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        .estimate-item {
            text-align: center;
        }

        .estimate-item .label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .estimate-item .value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #3b82f6;
        }

        /* Error/Success boxes */
        .error-box {
            background: #fee2e2;
            border: 1px solid #fca5a5;
            color: #991b1b;
            padding: 1rem;
            border-radius: 2px;
            margin-top: 1rem;
            display: none;
        }

        .success-box {
            background: #d1fae5;
            border: 1px solid #6ee7b7;
            color: #065f46;
            padding: 1.5rem;
            border-radius: 2px;
            text-align: center;
        }

        /* Research Type Selector */
        .research-type-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .research-type-option {
            border: 2px solid var(--border);
            border-radius: 2px;
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .research-type-option:hover {
            border-color: var(--primary-600);
        }

        .research-type-option.selected {
            border-color: var(--primary-600);
            background: rgba(59, 130, 246, 0.05);
        }

        .type-title {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .type-description {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        @media (max-width: 768px) {
            .category-grid,
            .settings-grid,
            .estimate-grid {
                grid-template-columns: 1fr;
            }

            .research-type-selector {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="site-header">
        <div class="container">
            <div class="header-nav">
                <a href="index.html" class="back-link">
                    <svg viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"/>
                    </svg>
                    Back to Research
                </a>
                <div class="header-content">
                    <h1 class="site-title">Autonomous Research Press</h1>
                    <p class="site-subtitle">Ask a New Research</p>
                </div>
                <button class="theme-toggle" aria-label="Toggle dark mode">
                    <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                    <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <main class="ask-topic-container">
        <!-- API Key -->
        <div class="form-section" style="margin-bottom: 1rem; padding: 1rem 2rem; display: flex; align-items: center; gap: 1rem;">
            <label for="api-key" style="font-weight: 600; white-space: nowrap;">API Key</label>
            <input type="password" id="api-key" placeholder="Enter your API key"
                   style="flex: 1; padding: 0.5rem 0.75rem; border: 1px solid var(--border); border-radius: 2px; background: var(--background); color: var(--text); font-size: 0.875rem;">
            <button class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.5rem 0.75rem;" onclick="saveApiKey()">Save</button>
            <span id="api-key-status" style="font-size: 0.75rem; color: var(--text-secondary);"></span>
        </div>
        <div id="rate-limit-warning" class="error-box" style="margin-bottom: 1rem;"></div>

        <!-- Step 1: Topic & Category -->
        <div id="step-topic" class="form-section">
            <h2><span class="step-badge">1</span> Research Topic</h2>

            <!-- Research Type -->
            <div class="form-group">
                <label>Research Type</label>
                <div class="research-type-selector">
                    <div class="research-type-option selected" data-type="survey" onclick="selectResearchType('survey')">
                        <div class="type-title">Survey / Literature Review</div>
                        <div class="type-description">Comprehensive review of existing research and state-of-the-art</div>
                    </div>
                    <div class="research-type-option" data-type="research" onclick="selectResearchType('research')">
                        <div class="type-title">Original Research</div>
                        <div class="type-description">In-depth analysis with novel insights and conclusions</div>
                    </div>
                </div>
            </div>

            <!-- Topic Input -->
            <div class="form-group">
                <label for="topic">Research Topic</label>
                <textarea
                    id="topic"
                    placeholder="e.g., Zero-Knowledge Rollup Security Analysis, Ethereum's Proof of Stake Mechanism"
                    rows="3"
                ></textarea>
                <p class="help-text">Describe the topic you want researched. The AI will suggest an appropriate academic category.</p>
            </div>

            <!-- Category Section (shown after AI analysis) -->
            <div id="category-section" class="category-section">
                <div class="category-header">
                    <h3>Suggested Category</h3>
                    <span id="category-badge" class="category-badge"></span>
                </div>
                <p class="help-text">The AI has analyzed your topic and suggested this category. You can modify it if needed.</p>
                <div class="category-grid">
                    <div class="category-select-group">
                        <label for="major-field">Major Field</label>
                        <select id="major-field" onchange="onMajorFieldChange()">
                            <!-- Populated by JS -->
                        </select>
                    </div>
                    <div class="category-select-group">
                        <label for="subfield">Subfield</label>
                        <select id="subfield" onchange="onSubfieldChange()">
                            <!-- Populated by JS -->
                        </select>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button id="analyze-btn" class="btn btn-primary" onclick="analyzeTopicAndProposeTeam()">
                    Analyze Topic & Propose Team
                </button>
            </div>
            <div id="topic-error" class="error-box"></div>
        </div>

        <!-- Step 2: Team Composition -->
        <div id="step-team" class="form-section team-section">
            <h2><span class="step-badge">2</span> Research Team</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                Based on your topic and category, the AI has composed the following research team:
            </p>

            <!-- Lead Author -->
            <div class="team-group">
                <div class="team-group-header">
                    <h3>Lead Author</h3>
                    <span class="team-group-badge">Plans, coordinates, writes</span>
                </div>
                <div id="lead-author-container"></div>
            </div>

            <!-- Co-Authors -->
            <div class="team-group">
                <div class="team-group-header">
                    <h3>Co-Authors</h3>
                    <span class="team-group-badge">Research, feedback, review sections</span>
                </div>
                <div id="coauthors-container"></div>
                <button class="author-action-btn" onclick="addCoAuthor()" style="margin-top: 0.5rem;">
                    + Add Co-Author
                </button>
            </div>

            <!-- Reviewers -->
            <div class="team-group">
                <div class="team-group-header">
                    <h3>Peer Reviewers</h3>
                    <span class="team-group-badge">From category expert pool</span>
                </div>
                <div id="reviewers-container"></div>
            </div>

            <div class="button-group">
                <button class="btn btn-secondary" onclick="backToTopic()">Back</button>
                <button class="btn btn-primary" onclick="goToSettings()">Configure Settings</button>
            </div>
        </div>

        <!-- Step 3: Workflow Settings -->
        <div id="step-settings" class="form-section" style="display: none;">
            <h2><span class="step-badge">3</span> Workflow Settings</h2>

            <div class="settings-grid">
                <div class="setting-item">
                    <label for="research-cycles">Research Note Cycles</label>
                    <input type="number" id="research-cycles" value="1" min="1" max="5">
                    <p class="help-text">Iterations of research notes + feedback</p>
                </div>
                <div class="setting-item">
                    <label for="max-rounds">Max Review Rounds</label>
                    <input type="number" id="max-rounds" value="3" min="1" max="10">
                    <p class="help-text">Peer review iterations</p>
                </div>
                <div class="setting-item">
                    <label for="threshold">Quality Threshold</label>
                    <input type="number" id="threshold" value="8.0" min="5.0" max="10.0" step="0.1">
                    <p class="help-text">Score to pass peer review</p>
                </div>
            </div>

            <div class="estimate-box">
                <h3>Workflow Estimate</h3>
                <div class="estimate-grid">
                    <div class="estimate-item">
                        <div class="label">Team Size</div>
                        <div class="value" id="est-team-size">-</div>
                    </div>
                    <div class="estimate-item">
                        <div class="label">Est. Time</div>
                        <div class="value" id="est-time">-</div>
                    </div>
                    <div class="estimate-item">
                        <div class="label">Est. Tokens</div>
                        <div class="value" id="est-tokens">-</div>
                    </div>
                    <div class="estimate-item">
                        <div class="label">Est. Cost</div>
                        <div class="value" id="est-cost">-</div>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-secondary" onclick="backToTeam()">Back</button>
                <button class="btn btn-primary" onclick="startWorkflow()">Start Research Workflow</button>
            </div>
            <div id="settings-error" class="error-box"></div>
        </div>
    </main>

    <footer class="site-footer">
        <div class="container">
            <p><strong>Platform:</strong> Autonomous Research Press</p>
            <p class="copyright">2026 Autonomous Research Press. All rights reserved.</p>
        </div>
    </footer>

    <script src="js/main.js"></script>
    <script>
        const API_BASE = '';

        // --- API Key helpers ---
        function getApiKey() {
            return localStorage.getItem('research_api_key') || '';
        }
        function saveApiKey() {
            const key = document.getElementById('api-key').value.trim();
            localStorage.setItem('research_api_key', key);
            document.getElementById('api-key-status').textContent = key ? 'Saved' : 'Cleared';
            setTimeout(() => document.getElementById('api-key-status').textContent = '', 2000);
        }
        function apiHeaders() {
            const headers = { 'Content-Type': 'application/json' };
            const key = getApiKey();
            if (key) headers['X-API-Key'] = key;
            return headers;
        }
        function handleApiError(response, errorDiv) {
            if (response.status === 403) {
                errorDiv.textContent = 'Invalid or missing API key. Please enter a valid key above.';
                errorDiv.style.display = 'block';
                return true;
            }
            if (response.status === 429) {
                response.json().then(data => {
                    const warningDiv = document.getElementById('rate-limit-warning');
                    warningDiv.textContent = data.detail || 'Rate limited. Please wait before submitting again.';
                    warningDiv.style.display = 'block';
                });
                return true;
            }
            return false;
        }
        // Load saved key on page load
        document.addEventListener('DOMContentLoaded', () => {
            const saved = getApiKey();
            if (saved) {
                document.getElementById('api-key').value = saved;
                document.getElementById('api-key-status').textContent = 'Loaded from saved';
            }
        });

        // Academic categories (loaded from backend or defined here)
        const ACADEMIC_CATEGORIES = {
            "computer_science": {
                "name": "Computer Science",
                "icon": "computer",
                "subfields": {
                    "ai_ml": { "name": "AI & Machine Learning", "expert_pool": ["deep_learning_expert", "nlp_expert", "computer_vision_expert", "reinforcement_learning_expert"] },
                    "systems": { "name": "Systems & Distributed Computing", "expert_pool": ["distributed_systems_expert", "os_expert", "networking_expert", "database_expert"] },
                    "theory": { "name": "Theory & Algorithms", "expert_pool": ["algorithms_expert", "complexity_theory_expert", "formal_methods_expert", "computational_theory_expert"] },
                    "security": { "name": "Security & Cryptography", "expert_pool": ["cryptography_expert", "network_security_expert", "blockchain_expert", "privacy_expert"] },
                    "software_eng": { "name": "Software Engineering", "expert_pool": ["software_architecture_expert", "programming_languages_expert", "testing_expert", "devops_expert"] },
                    "hci": { "name": "Human-Computer Interaction", "expert_pool": ["ux_expert", "interaction_design_expert", "accessibility_expert", "visualization_expert"] }
                }
            },
            "engineering": {
                "name": "Engineering & Technology",
                "icon": "build",
                "subfields": {
                    "electrical": { "name": "Electrical & Electronics Engineering", "expert_pool": ["circuits_expert", "signal_processing_expert", "embedded_systems_expert", "power_systems_expert"] },
                    "mechanical": { "name": "Mechanical Engineering", "expert_pool": ["thermodynamics_expert", "fluid_mechanics_expert", "materials_expert", "robotics_expert"] },
                    "civil": { "name": "Civil & Structural Engineering", "expert_pool": ["structural_analysis_expert", "geotechnical_expert", "transportation_expert", "construction_expert"] },
                    "materials": { "name": "Materials Science", "expert_pool": ["nanomaterials_expert", "polymers_expert", "metallurgy_expert", "composites_expert"] }
                }
            },
            "natural_sciences": {
                "name": "Natural Sciences",
                "icon": "science",
                "subfields": {
                    "physics": { "name": "Physics & Astronomy", "expert_pool": ["quantum_physics_expert", "particle_physics_expert", "astrophysics_expert", "condensed_matter_expert"] },
                    "chemistry": { "name": "Chemistry", "expert_pool": ["organic_chemistry_expert", "inorganic_chemistry_expert", "physical_chemistry_expert", "analytical_chemistry_expert"] },
                    "biology": { "name": "Biology & Life Sciences", "expert_pool": ["molecular_biology_expert", "genetics_expert", "ecology_expert", "evolutionary_biology_expert"] },
                    "earth_science": { "name": "Earth & Environmental Sciences", "expert_pool": ["climate_science_expert", "geology_expert", "oceanography_expert", "environmental_science_expert"] },
                    "mathematics": { "name": "Pure Mathematics", "expert_pool": ["number_theory_expert", "topology_expert", "analysis_expert", "algebra_expert"] }
                }
            },
            "social_sciences": {
                "name": "Social Sciences",
                "icon": "groups",
                "subfields": {
                    "economics": { "name": "Economics", "expert_pool": ["microeconomics_expert", "macroeconomics_expert", "econometrics_expert", "game_theory_expert"] },
                    "sociology": { "name": "Sociology", "expert_pool": ["social_theory_expert", "urban_sociology_expert", "social_networks_expert", "demography_expert"] },
                    "political_science": { "name": "Political Science", "expert_pool": ["political_theory_expert", "comparative_politics_expert", "international_relations_expert", "public_policy_expert"] },
                    "psychology": { "name": "Psychology", "expert_pool": ["cognitive_psychology_expert", "behavioral_economics_expert", "social_psychology_expert", "neuroscience_expert"] },
                    "anthropology": { "name": "Anthropology", "expert_pool": ["cultural_anthropology_expert", "archaeology_expert", "linguistic_anthropology_expert", "biological_anthropology_expert"] }
                }
            },
            "humanities": {
                "name": "Humanities",
                "icon": "menu_book",
                "subfields": {
                    "philosophy": { "name": "Philosophy", "expert_pool": ["ethics_expert", "epistemology_expert", "metaphysics_expert", "logic_expert"] },
                    "history": { "name": "History", "expert_pool": ["ancient_history_expert", "modern_history_expert", "historiography_expert", "social_history_expert"] },
                    "literature": { "name": "Literature & Literary Studies", "expert_pool": ["literary_theory_expert", "comparative_literature_expert", "poetry_expert", "narrative_studies_expert"] },
                    "linguistics": { "name": "Linguistics", "expert_pool": ["syntax_expert", "semantics_expert", "phonology_expert", "sociolinguistics_expert"] }
                }
            },
            "business_economics": {
                "name": "Business & Economics",
                "icon": "trending_up",
                "subfields": {
                    "finance": { "name": "Finance & Accounting", "expert_pool": ["corporate_finance_expert", "financial_markets_expert", "accounting_expert", "risk_management_expert"] },
                    "management": { "name": "Management & Strategy", "expert_pool": ["strategic_management_expert", "organizational_behavior_expert", "leadership_expert", "innovation_management_expert"] },
                    "marketing": { "name": "Marketing", "expert_pool": ["consumer_behavior_expert", "digital_marketing_expert", "brand_management_expert", "market_research_expert"] }
                }
            },
            "medicine_health": {
                "name": "Medicine & Health Sciences",
                "icon": "local_hospital",
                "subfields": {
                    "clinical": { "name": "Clinical Medicine", "expert_pool": ["internal_medicine_expert", "surgery_expert", "diagnostics_expert", "therapeutics_expert"] },
                    "public_health": { "name": "Public Health & Epidemiology", "expert_pool": ["epidemiology_expert", "health_policy_expert", "disease_prevention_expert", "global_health_expert"] },
                    "pharmacology": { "name": "Pharmacology", "expert_pool": ["drug_discovery_expert", "pharmacokinetics_expert", "clinical_trials_expert", "toxicology_expert"] }
                }
            },
            "law_policy": {
                "name": "Law & Public Policy",
                "icon": "gavel",
                "subfields": {
                    "law": { "name": "Law & Legal Studies", "expert_pool": ["constitutional_law_expert", "international_law_expert", "corporate_law_expert", "legal_theory_expert"] },
                    "policy": { "name": "Public Policy & Administration", "expert_pool": ["policy_analysis_expert", "public_administration_expert", "governance_expert", "regulatory_policy_expert"] }
                }
            }
        };

        let currentProposal = null;
        let selectedCategory = { major: null, subfield: null };

        // Initialize category dropdowns
        function initCategoryDropdowns() {
            const majorSelect = document.getElementById('major-field');
            majorSelect.innerHTML = '<option value="">Select major field...</option>';

            for (const [key, data] of Object.entries(ACADEMIC_CATEGORIES)) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = data.name;
                majorSelect.appendChild(option);
            }
        }

        function onMajorFieldChange() {
            const majorField = document.getElementById('major-field').value;
            const subfieldSelect = document.getElementById('subfield');

            subfieldSelect.innerHTML = '<option value="">Select subfield...</option>';

            if (majorField && ACADEMIC_CATEGORIES[majorField]) {
                const subfields = ACADEMIC_CATEGORIES[majorField].subfields;
                for (const [key, data] of Object.entries(subfields)) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = data.name;
                    subfieldSelect.appendChild(option);
                }
            }

            selectedCategory.major = majorField;
            selectedCategory.subfield = null;
            updateCategoryBadge();
        }

        function onSubfieldChange() {
            selectedCategory.subfield = document.getElementById('subfield').value;
            updateCategoryBadge();
            updateReviewerPool();
        }

        function updateCategoryBadge() {
            const badge = document.getElementById('category-badge');
            if (selectedCategory.major && selectedCategory.subfield) {
                const majorName = ACADEMIC_CATEGORIES[selectedCategory.major].name;
                const subfieldName = ACADEMIC_CATEGORIES[selectedCategory.major].subfields[selectedCategory.subfield].name;
                badge.textContent = `${majorName} > ${subfieldName}`;
            } else if (selectedCategory.major) {
                badge.textContent = ACADEMIC_CATEGORIES[selectedCategory.major].name;
            } else {
                badge.textContent = 'Not selected';
            }
        }

        function updateReviewerPool() {
            if (!selectedCategory.major || !selectedCategory.subfield) return;

            const pool = ACADEMIC_CATEGORIES[selectedCategory.major].subfields[selectedCategory.subfield].expert_pool;
            const container = document.getElementById('reviewers-container');

            container.innerHTML = pool.map((expert, idx) => `
                <div class="author-card reviewer">
                    <div class="author-header">
                        <h4 class="author-name">${formatExpertName(expert)}</h4>
                        <span class="author-model">Reviewer ${idx + 1}</span>
                    </div>
                    <div class="author-rationale">From category expert pool: ${selectedCategory.subfield}</div>
                </div>
            `).join('');
        }

        function formatExpertName(expertKey) {
            return expertKey
                .replace(/_expert$/, '')
                .split('_')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ') + ' Expert';
        }

        // Research type selection
        function selectResearchType(type) {
            document.querySelectorAll('.research-type-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`.research-type-option[data-type="${type}"]`).classList.add('selected');
        }

        // Analyze topic and propose team
        async function analyzeTopicAndProposeTeam() {
            const topic = document.getElementById('topic').value.trim();
            const researchType = document.querySelector('.research-type-option.selected').dataset.type;
            const errorDiv = document.getElementById('topic-error');
            const btn = document.getElementById('analyze-btn');

            if (!topic) {
                errorDiv.textContent = 'Please enter a research topic.';
                errorDiv.style.display = 'block';
                return;
            }

            errorDiv.style.display = 'none';
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Analyzing topic...';

            try {
                const response = await fetch(`${API_BASE}/api/propose-team`, {
                    method: 'POST',
                    headers: apiHeaders(),
                    body: JSON.stringify({
                        topic: topic,
                        research_type: researchType
                    })
                });

                if (!response.ok) {
                    if (handleApiError(response, errorDiv)) return;
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const proposal = await response.json();
                currentProposal = proposal;

                // Show category section
                document.getElementById('category-section').classList.add('active');

                // Set suggested category (if returned from API)
                if (proposal.suggested_category) {
                    document.getElementById('major-field').value = proposal.suggested_category.major;
                    onMajorFieldChange();
                    document.getElementById('subfield').value = proposal.suggested_category.subfield;
                    onSubfieldChange();
                } else {
                    // Default to computer_science/security for blockchain topics
                    if (topic.toLowerCase().includes('blockchain') ||
                        topic.toLowerCase().includes('crypto') ||
                        topic.toLowerCase().includes('rollup') ||
                        topic.toLowerCase().includes('ethereum')) {
                        document.getElementById('major-field').value = 'computer_science';
                        onMajorFieldChange();
                        document.getElementById('subfield').value = 'security';
                        onSubfieldChange();
                    }
                }

                // Display team
                displayTeam(proposal);

                // Show team section
                document.getElementById('step-team').classList.add('active');
                document.getElementById('step-team').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                errorDiv.textContent = `Error: ${error.message}`;
                errorDiv.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Analyze Topic & Propose Team';
            }
        }

        function displayTeam(proposal) {
            const experts = proposal.proposed_experts || [];

            // First expert is Lead Author
            const leadContainer = document.getElementById('lead-author-container');
            if (experts.length > 0) {
                const lead = experts[0];
                leadContainer.innerHTML = createAuthorCard(lead, 0, true);
            }

            // Rest are Co-Authors
            const coauthorsContainer = document.getElementById('coauthors-container');
            if (experts.length > 1) {
                coauthorsContainer.innerHTML = experts.slice(1).map((expert, idx) =>
                    createAuthorCard(expert, idx + 1, false)
                ).join('');
            } else {
                coauthorsContainer.innerHTML = '<p style="color: var(--text-secondary); font-style: italic;">No co-authors assigned yet.</p>';
            }

            // Update reviewers based on category
            updateReviewerPool();
        }

        function createAuthorCard(expert, idx, isLead) {
            const cardClass = isLead ? 'author-card lead' : 'author-card';
            return `
                <div class="${cardClass}" data-idx="${idx}">
                    <div class="author-header">
                        <h4 class="author-name">${expert.expert_domain}</h4>
                        <span class="author-model">${expert.suggested_model || 'claude-sonnet-4.5'}</span>
                    </div>
                    <div class="author-rationale">${expert.rationale || 'AI-proposed based on topic analysis'}</div>
                    <div class="author-focus-areas">
                        ${(expert.focus_areas || []).map(area => `<span class="focus-tag">${area}</span>`).join('')}
                    </div>
                    <div class="author-actions">
                        <button class="author-action-btn" onclick="editAuthor(${idx})">Edit</button>
                        <button class="author-action-btn" onclick="customizeAuthor(${idx})">Customize</button>
                        ${!isLead ? `<button class="author-action-btn" onclick="removeAuthor(${idx})">Remove</button>` : ''}
                    </div>
                    <div id="customize-panel-${idx}" class="customization-panel">
                        <div class="custom-tabs">
                            <button class="custom-tab active" onclick="switchCustomTab(${idx}, 'desc')">Description</button>
                            <button class="custom-tab" onclick="switchCustomTab(${idx}, 'url')">URL</button>
                            <button class="custom-tab" onclick="switchCustomTab(${idx}, 'pdf')">PDF</button>
                        </div>
                        <div id="custom-content-${idx}" class="custom-content">
                            <textarea id="custom-desc-${idx}" placeholder="Describe the expertise you want for this author..."></textarea>
                            <button class="btn btn-secondary" style="margin-top: 0.5rem; font-size: 0.75rem; padding: 0.5rem;" onclick="applyCustomization(${idx})">Apply</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function editAuthor(idx) {
            const expert = currentProposal.proposed_experts[idx];
            const newDomain = prompt('Edit author domain:', expert.expert_domain);
            if (newDomain && newDomain.trim()) {
                expert.expert_domain = newDomain.trim();
                displayTeam(currentProposal);
            }
        }

        function customizeAuthor(idx) {
            const panel = document.getElementById(`customize-panel-${idx}`);
            panel.classList.toggle('active');
        }

        function switchCustomTab(idx, tab) {
            const panel = document.getElementById(`customize-panel-${idx}`);
            panel.querySelectorAll('.custom-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            const content = document.getElementById(`custom-content-${idx}`);
            if (tab === 'desc') {
                content.innerHTML = `
                    <textarea id="custom-desc-${idx}" placeholder="Describe the expertise you want..."></textarea>
                    <button class="btn btn-secondary" style="margin-top: 0.5rem; font-size: 0.75rem; padding: 0.5rem;" onclick="applyCustomization(${idx}, 'desc')">Apply</button>
                `;
            } else if (tab === 'url') {
                content.innerHTML = `
                    <input type="text" id="custom-url-${idx}" placeholder="Enter URL (paper, blog, profile)...">
                    <button class="btn btn-secondary" style="margin-top: 0.5rem; font-size: 0.75rem; padding: 0.5rem;" onclick="applyCustomization(${idx}, 'url')">Analyze & Apply</button>
                `;
            } else if (tab === 'pdf') {
                content.innerHTML = `
                    <input type="file" id="custom-pdf-${idx}" accept=".pdf">
                    <button class="btn btn-secondary" style="margin-top: 0.5rem; font-size: 0.75rem; padding: 0.5rem;" onclick="applyCustomization(${idx}, 'pdf')">Analyze & Apply</button>
                `;
            }
        }

        function applyCustomization(idx, type = 'desc') {
            const expert = currentProposal.proposed_experts[idx];

            if (type === 'desc') {
                const desc = document.getElementById(`custom-desc-${idx}`).value.trim();
                if (desc) {
                    expert.custom_description = desc;
                    expert.rationale = `Custom: ${desc.substring(0, 100)}...`;
                }
            } else if (type === 'url') {
                const url = document.getElementById(`custom-url-${idx}`).value.trim();
                if (url) {
                    expert.custom_url = url;
                    expert.rationale = `Expertise extracted from: ${url}`;
                    // TODO: Call API to analyze URL and get description
                }
            } else if (type === 'pdf') {
                const file = document.getElementById(`custom-pdf-${idx}`).files[0];
                if (file) {
                    expert.custom_pdf = file.name;
                    expert.rationale = `Expertise extracted from PDF: ${file.name}`;
                    // TODO: Call API to analyze PDF and get description
                }
            }

            displayTeam(currentProposal);
        }

        function removeAuthor(idx) {
            if (confirm('Remove this co-author?')) {
                currentProposal.proposed_experts.splice(idx, 1);
                displayTeam(currentProposal);
            }
        }

        function addCoAuthor() {
            const domain = prompt('Enter co-author specialty:');
            if (domain && domain.trim()) {
                currentProposal.proposed_experts.push({
                    expert_domain: domain.trim(),
                    rationale: 'Manually added co-author',
                    focus_areas: [],
                    suggested_model: 'claude-sonnet-4.5'
                });
                displayTeam(currentProposal);
            }
        }

        // Navigation
        function backToTopic() {
            document.getElementById('step-team').classList.remove('active');
        }

        function goToSettings() {
            // Update estimates
            const teamSize = currentProposal.proposed_experts.length +
                (selectedCategory.subfield ? ACADEMIC_CATEGORIES[selectedCategory.major].subfields[selectedCategory.subfield].expert_pool.length : 3);
            const cycles = parseInt(document.getElementById('research-cycles')?.value || 1);
            const rounds = parseInt(document.getElementById('max-rounds')?.value || 3);

            document.getElementById('est-team-size').textContent = teamSize;
            document.getElementById('est-time').textContent = `~${5 + cycles * 10 + rounds * 5}min`;
            document.getElementById('est-tokens').textContent = `~${(teamSize * rounds * 7000).toLocaleString()}`;
            document.getElementById('est-cost').textContent = `$${((teamSize * rounds * 7000) / 1000000 * 18).toFixed(2)}`;

            document.getElementById('step-settings').style.display = 'block';
            document.getElementById('step-settings').scrollIntoView({ behavior: 'smooth' });
        }

        function backToTeam() {
            document.getElementById('step-settings').style.display = 'none';
        }

        // Start workflow
        async function startWorkflow() {
            const errorDiv = document.getElementById('settings-error');
            const researchCycles = parseInt(document.getElementById('research-cycles').value);
            const maxRounds = parseInt(document.getElementById('max-rounds').value);
            const threshold = parseFloat(document.getElementById('threshold').value);

            if (!currentProposal) {
                errorDiv.textContent = 'No team proposal found.';
                errorDiv.style.display = 'block';
                return;
            }

            errorDiv.style.display = 'none';

            try {
                const response = await fetch(`${API_BASE}/api/start-workflow`, {
                    method: 'POST',
                    headers: apiHeaders(),
                    body: JSON.stringify({
                        topic: currentProposal.topic,
                        experts: currentProposal.proposed_experts,
                        max_rounds: maxRounds,
                        threshold: threshold,
                        research_cycles: researchCycles,
                        category: selectedCategory
                    })
                });

                if (!response.ok) {
                    if (handleApiError(response, errorDiv)) return;
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const result = await response.json();

                // Redirect to queue
                window.location.href = `research-queue.html?highlight=${encodeURIComponent(result.project_id)}`;

            } catch (error) {
                errorDiv.textContent = `Error: ${error.message}`;
                errorDiv.style.display = 'block';
            }
        }

        // Initialize
        initCategoryDropdowns();
    </script>
</body>
</html>
